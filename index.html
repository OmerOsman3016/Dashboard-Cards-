<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'">
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="./css/styles.css">

  <!-- External JS -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 
  <style>
    /* Add styles for the timeline section */
    .timeline-container {
      width: 98%;
      margin: 10px auto;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .timeline-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    #timeline-chart {
      width: 100%;
      height: 270px;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 10px;
      padding: 5px 10px;
      border-radius: 20px;
      background: #f5f5f5;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .legend-item:hover {
      background: #e0e0e0;
    }
    
    .legend-item.active {
      background: rgba(0,0,0,0.1);
      box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
    }
    
    .legend-color {
      width: 15px;
      height: 15px;
      margin-right: 8px;
      border-radius: 3px;
    }
    
    /* Custom tooltip styling */
    .hovertext {
      font-family: Arial, sans-serif;
      font-size: 12px;
      padding: 8px 12px !important;
      border-radius: 4px !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
    }
  </style>
</head>

<body>
   
  <!-- Dashboard Cards Container -->
  <div class="dashboard-cards">
    <!-- Card 1: Internally Displaced Persons -->
    <div class="dashboard-card" style="--card-color: #2A81CB;">
      <div class="card-icon">
        <img src="./data/Internally displaced.png" alt="IDP Icon" class="card-icon-img">
      </div>
      <h3>Internally Displaced</h3>
      <div class="value">11,301,340</div>
      <div class="change negative">
        <i class="fas fa-arrow-down"></i> 1.7% since last update
      </div>
      <div class="card-footer">Nationwide</div>
    </div>

    <!-- Card 2: Returnees -->
    <div class="dashboard-card" style="--card-color: #5CB85C;">
      <div class="card-icon">
        <img src="./data/Returnees.png" alt="IDP Icon" class="card-icon-img">
      </div>
      <h3>Returnees</h3>
      <div class="value">396,738</div>
      <div class="change positive">
        <i class="fas fa-arrow-up"></i> 0.0% since last update
      </div>
      <div class="card-footer">Nationwide</div>
    </div>

    <!-- Card 3: Crossing Border -->
    <div class="dashboard-card" style="--card-color: #F0AD4E;">
      <div class="card-icon">
        <img src="./data/Crossing Border.png" alt="IDP Icon" class="card-icon-img">
      </div>
      <h3>Crossing Border</h3>
      <div class="value">3,934,086</div>
      <div class="change positive">
        <i class="fas fa-arrow-up"></i> 0.8% since last update
      </div>
      <div class="card-footer">Neighboring countries</div>
    </div>

    <!-- Card 4: Migrants Affected -->
    <div class="dashboard-card" style="--card-color: #D9534F;">
      <div class="card-icon">
        <img src="./data/Crossing Border.png" alt="IDP Icon" class="card-icon-img">  
      </div>
      <h3>Migrants Affected</h3>
      <div class="value">400,000</div>
      <div class="change negative">
        <i class="fas fa-arrow-down"></i> 2.1% since last update
      </div>
      <div class="card-footer">Migrants </div>
    </div>
  </div>
  
  <!-- Timeline Section -->
  <div class="timeline-container">
    <div class="timeline-header">
      <div class="timeline-title">Displacement Trends Over Time</div>
    </div>
    <div id="timeline-chart"></div>
    <div class="legend" id="timeline-legend">
      <div class="legend-item active" data-trace="0">
        <div class="legend-color" style="background-color: #2A81CB;"></div>
        <span>Internally Displaced</span>
      </div>
      <div class="legend-item active" data-trace="1">
        <div class="legend-color" style="background-color: #5CB85C;"></div>
        <span>Returnees</span>
      </div>
      <div class="legend-item active" data-trace="2">
        <div class="legend-color" style="background-color: #F0AD4E;"></div>
        <span>Border Crossings</span>
      </div>
    </div>
  </div>

  <script>
    // Data for the timeline
    const displacementData = [
      {date: 'Apr-23', idps: 3200000, returnees: 50000, border_crossings: 800000},
      {date: 'May-23', idps: 3450000, returnees: 75000, border_crossings: 900000},
      {date: 'Jun-23', idps: 3800000, returnees: 100000, border_crossings: 1000000},
      {date: 'Jul-23', idps: 4100000, returnees: 150000, border_crossings: 1100000},
      {date: 'Aug-23', idps: 4350000, returnees: 200000, border_crossings: 1200000},
      {date: 'Sep-23', idps: 4600000, returnees: 250000, border_crossings: 1300000},
      {date: 'Oct-23', idps: 4900000, returnees: 300000, border_crossings: 1400000},
      {date: 'Nov-23', idps: 5200000, returnees: 350000, border_crossings: 1500000},
      {date: 'Dec-23', idps: 5500000, returnees: 400000, border_crossings: 1600000},
      {date: 'Jan-24', idps: 5800000, returnees: 450000, border_crossings: 1700000},
      {date: 'Feb-24', idps: 6100000, returnees: 500000, border_crossings: 1800000},
      {date: 'Mar-24', idps: 6400000, returnees: 550000, border_crossings: 1900000},
      {date: 'Apr-24', idps: 6700000, returnees: 600000, border_crossings: 2000000},
      {date: 'May-24', idps: 7000000, returnees: 650000, border_crossings: 2100000},
      {date: 'Jun-24', idps: 7300000, returnees: 750000, border_crossings: 2200000},
      {date: 'Jul-24', idps: 7600000, returnees: 800000, border_crossings: 2300000},
      {date: 'Aug-24', idps: 7900000, returnees: 850000, border_crossings: 2400000},
      {date: 'Sep-24', idps: 8200000, returnees: 900000, border_crossings: 2500000},
      {date: 'Oct-24', idps: 8500000, returnees: 950000, border_crossings: 2600000},
      {date: 'Nov-24', idps: 8800000, returnees: 1000000, border_crossings: 2650000},
      {date: 'Dec-24', idps: 9100000, returnees: 1050000, border_crossings: 2700000},
      {date: 'Jan-25', idps: 9300000, returnees: 1150000, border_crossings: 2750000},
      {date: 'Feb-25', idps: 9350000, returnees: 1150000, border_crossings: 2780000},
      {date: 'Mar-25', idps: 9400000, returnees: 1200000, border_crossings: 2800000}
    ];

    // Prepare data for Plotly
    const dates = displacementData.map(item => item.date);
    const idps = displacementData.map(item => item.idps);
    const returnees = displacementData.map(item => item.returnees);
    const borderCrossings = displacementData.map(item => item.border_crossings);

    // Create traces for each data series
    const trace1 = {
      x: dates,
      y: idps,
      name: 'Internally Displaced',
      mode: 'lines+markers',
      line: {color: '#2A81CB', width: 3, shape: 'spline'},
      marker: {size: 6, symbol: 'circle'},
      hovertemplate: '<b>%{x}</b><br>Internally Displaced: %{y:,}<extra></extra>'
    };

    const trace2 = {
      x: dates,
      y: returnees,
      name: 'Returnees',
      mode: 'lines+markers',
      line: {color: '#5CB85C', width: 3, shape: 'spline'},
      marker: {size: 6, symbol: 'diamond'},
      hovertemplate: '<b>%{x}</b><br>Returnees: %{y:,}<extra></extra>'
    };

    const trace3 = {
      x: dates,
      y: borderCrossings,
      name: 'Border Crossings',
      mode: 'lines+markers',
      line: {color: '#F0AD4E', width: 3, shape: 'spline'},
      marker: {size: 6, symbol: 'square'},
      hovertemplate: '<b>%{x}</b><br>Border Crossings: %{y:,}<extra></extra>'
    };

    const data = [trace1, trace2, trace3];

    // Layout configuration
    const layout = {
      title: '',
      xaxis: {
        title: 'Month',
        tickangle: -45,
        gridcolor: '#f0f0f0',
        showline: true,
        linecolor: '#ccc'
      },
      yaxis: {
        title: 'Number of People',
        tickformat: ',.0f',
        gridcolor: '#f0f0f0',
        showline: true,
        linecolor: '#ccc'
      },
      hovermode: 'closest',
      showlegend: false,
      margin: {l: 60, r: 30, t: 30, b: 80},
      plot_bgcolor: 'rgba(0,0,0,0)',
      paper_bgcolor: 'rgba(0,0,0,0)',
      transition: {
        duration: 500,
        easing: 'cubic-in-out'
      }
    };

    // Configuration options
    const config = {
      responsive: true,
      displayModeBar: true,
      scrollZoom: true,
      displaylogo: false
    };

    // Create the chart when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Create the timeline chart
      const chart = document.getElementById('timeline-chart');
      Plotly.newPlot(chart, data, layout, config);
      
      // Add legend interactivity
      const legendItems = document.querySelectorAll('#timeline-legend .legend-item');
      
      legendItems.forEach(item => {
        item.addEventListener('click', function() {
          const traceIndex = parseInt(this.getAttribute('data-trace'));
          const isActive = this.classList.contains('active');
          
          if (isActive) {
            this.classList.remove('active');
            Plotly.restyle(chart, {visible: false}, [traceIndex]);
          } else {
            this.classList.add('active');
            Plotly.restyle(chart, {visible: true}, [traceIndex]);
          }
        });
      });
      
      // Add hover effects
      chart.on('plotly_hover', function(data) {
        const point = data.points[0];
        console.log('Hovered over:', point.data.name, '=', point.y.toLocaleString());
      });
      
      // Add click effects
      chart.on('plotly_click', function(data) {
        const point = data.points[0];
        console.log('Clicked on:', point.data.name, '=', point.y.toLocaleString(), 'at', point.x);
      });
      
      // Make chart responsive to window resize
      window.addEventListener('resize', function() {
        Plotly.Plots.resize(chart);
      });
    });
  </script>
</body>
</html>
